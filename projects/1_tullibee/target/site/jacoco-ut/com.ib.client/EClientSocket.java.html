<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EClientSocket.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">tullibee-jacoco-offline</a> &gt; <a href="index.source.html" class="el_package">com.ib.client</a> &gt; <span class="el_source">EClientSocket.java</span></div><h1>EClientSocket.java</h1><pre class="source lang-java linenums">// Copyright 2010-2012 Christopher Redekop
//  
// This file is part of the Tullibee API, a modified version of Interactive
// Brokers' Java API (the IB API).
//  
// The Tullibee API is free software: you can redistribute it and/or modify it
// under the terms of the GNU Lesser General Public License as published by
// the Free Software Foundation, either version 3 of the License, or (at your
// option) any later version.
//  
// The Tullibee API is distributed in the hope that it will be useful, but
// WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
// or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public
// License for more details.
//  
// You should have received a copy of the GNU Lesser General Public License
// along with the Tullibee API.  If not, see &lt;http://www.gnu.org/licenses/&gt;.

/*
 * EClientSocket.java
 *
 */
package com.ib.client;

import static com.ib.client.EClientErrors.ALREADY_CONNECTED;
import static com.ib.client.EClientErrors.NO_VALID_ID;
import static com.ib.client.EClientErrors.UPDATE_TWS;
import static com.ib.client.EReader.readInt;
import static com.ib.client.EReader.readStr;

import java.io.DataInputStream;
import java.io.DataOutputStream;
import java.io.IOException;
import java.net.Socket;

import com.ib.client.EClientErrors.CodeMsgPair;

<span class="fc" id="L38">public class EClientSocket {</span>

	// Client version history
	//
	// 6 = Added parentId to orderStatus
	// 7 = The new execDetails event returned for an order filled status and
	// reqExecDetails
	// Also market depth is available.
	// 8 = Added lastFillPrice to orderStatus() event and permId to execution
	// details
	// 9 = Added 'averageCost', 'unrealizedPNL', and 'unrealizedPNL' to
	// updatePortfolio event
	// 10 = Added 'serverId' to the 'open order' &amp; 'order status' events.
	// We send back all the API open orders upon connection.
	// Added new methods reqAllOpenOrders, reqAutoOpenOrders()
	// Added FA support - reqExecution has filter.
	// - reqAccountUpdates takes acct code.
	// 11 = Added permId to openOrder event.
	// 12 = requsting open order attributes ignoreRth, hidden, and discretionary
	// 13 = added goodAfterTime
	// 14 = always send size on bid/ask/last tick
	// 15 = send allocation description string on openOrder
	// 16 = can receive account name in account and portfolio updates, and fa
	// params in openOrder
	// 17 = can receive liquidation field in exec reports, and notAutoAvailable
	// field in mkt data
	// 18 = can receive good till date field in open order messages, and request
	// intraday backfill
	// 19 = can receive rthOnly flag in ORDER_STATUS
	// 20 = expects TWS time string on connection after server version &gt;= 20.
	// 21 = can receive bond contract details.
	// 22 = can receive price magnifier in version 2 contract details message
	// 23 = support for scanner
	// 24 = can receive volatility order parameters in open order messages
	// 25 = can receive HMDS query start and end times
	// 26 = can receive option vols in option market data messages
	// 27 = can receive delta neutral order type and delta neutral aux price in
	// place order version 20: API 8.85
	// 28 = can receive option model computation ticks: API 8.9
	// 29 = can receive trail stop limit price in open order and can place them:
	// API 8.91
	// 30 = can receive extended bond contract def, new ticks, and trade count
	// in bars
	// 31 = can receive EFP extensions to scanner and market data, and combo
	// legs on open orders
	// ; can receive RT bars
	// 32 = can receive TickType.LAST_TIMESTAMP
	// ; can receive &quot;whyHeld&quot; in order status messages
	// 33 = can receive ScaleNumComponents and ScaleComponentSize is open order
	// messages
	// 34 = can receive whatIf orders / order state
	// 35 = can receive contId field for Contract objects
	// 36 = can receive outsideRth field for Order objects
	// 37 = can receive clearingAccount and clearingIntent for Order objects
	// 38 = can receive multiplier and primaryExchange in portfolio updates
	// ; can receive cumQty and avgPrice in execution
	// ; can receive fundamental data
	// ; can receive underComp for Contract objects
	// ; can receive reqId and end marker in contractDetails/bondContractDetails
	// ; can receive ScaleInitComponentSize and ScaleSubsComponentSize for Order
	// objects
	// 39 = can receive underConId in contractDetails
	// 40 = can receive algoStrategy/algoParams in openOrder
	// 41 = can receive end marker for openOrder
	// ; can receive end marker for account download
	// ; can receive end marker for executions download
	// 42 = can receive deltaNeutralValidation
	// 43 = can receive longName(companyName)
	// ; can receive listingExchange
	// ; can receive RTVolume tick
	// 44 = can receive end market for ticker snapshot
	// 45 = can receive notHeld field in openOrder
	// 46 = can receive contractMonth, industry, category, subcategory fields in
	// contractDetails
	// ; can receive timeZoneId, tradingHours, liquidHours fields in
	// contractDetails

	private static final int CLIENT_VERSION = 46;
	private static final int SERVER_VERSION = 38;
<span class="fc" id="L117">	private static final byte[] EOL = { 0 };</span>
	private static final String BAG_SEC_TYPE = &quot;BAG&quot;;

	// FA msg data types
	public static final int GROUPS = 1;
	public static final int PROFILES = 2;
	public static final int ALIASES = 3;

	public static String faMsgTypeName(int faDataType) {
<span class="nc bnc" id="L126" title="All 4 branches missed.">		switch (faDataType) {</span>
		case GROUPS:
<span class="nc" id="L128">			return &quot;GROUPS&quot;;</span>
		case PROFILES:
<span class="nc" id="L130">			return &quot;PROFILES&quot;;</span>
		case ALIASES:
<span class="nc" id="L132">			return &quot;ALIASES&quot;;</span>
		}
<span class="nc" id="L134">		return null;</span>
	}

	// outgoing msg id's
	private static final int REQ_MKT_DATA = 1;
	private static final int CANCEL_MKT_DATA = 2;
	private static final int PLACE_ORDER = 3;
	private static final int CANCEL_ORDER = 4;
	private static final int REQ_OPEN_ORDERS = 5;
	private static final int REQ_ACCOUNT_DATA = 6;
	private static final int REQ_EXECUTIONS = 7;
	private static final int REQ_IDS = 8;
	private static final int REQ_CONTRACT_DATA = 9;
	private static final int REQ_MKT_DEPTH = 10;
	private static final int CANCEL_MKT_DEPTH = 11;
	private static final int REQ_NEWS_BULLETINS = 12;
	private static final int CANCEL_NEWS_BULLETINS = 13;
	private static final int SET_SERVER_LOGLEVEL = 14;
	private static final int REQ_AUTO_OPEN_ORDERS = 15;
	private static final int REQ_ALL_OPEN_ORDERS = 16;
	private static final int REQ_MANAGED_ACCTS = 17;
	private static final int REQ_FA = 18;
	private static final int REPLACE_FA = 19;
	private static final int REQ_HISTORICAL_DATA = 20;
	private static final int EXERCISE_OPTIONS = 21;
	private static final int REQ_SCANNER_SUBSCRIPTION = 22;
	private static final int CANCEL_SCANNER_SUBSCRIPTION = 23;
	private static final int REQ_SCANNER_PARAMETERS = 24;
	private static final int CANCEL_HISTORICAL_DATA = 25;
	private static final int REQ_CURRENT_TIME = 49;
	private static final int REQ_REAL_TIME_BARS = 50;
	private static final int CANCEL_REAL_TIME_BARS = 51;
	private static final int REQ_FUNDAMENTAL_DATA = 52;
	private static final int CANCEL_FUNDAMENTAL_DATA = 53;

	private static final int MIN_SERVER_VER_REAL_TIME_BARS = 34;
	private static final int MIN_SERVER_VER_SCALE_ORDERS = 35;
	private static final int MIN_SERVER_VER_SNAPSHOT_MKT_DATA = 35;
	private static final int MIN_SERVER_VER_SSHORT_COMBO_LEGS = 35;
	private static final int MIN_SERVER_VER_WHAT_IF_ORDERS = 36;
	private static final int MIN_SERVER_VER_CONTRACT_CONID = 37;
	private static final int MIN_SERVER_VER_PTA_ORDERS = 39;
	private static final int MIN_SERVER_VER_FUNDAMENTAL_DATA = 40;
	private static final int MIN_SERVER_VER_UNDER_COMP = 40;
	private static final int MIN_SERVER_VER_CONTRACT_DATA_CHAIN = 40;
	private static final int MIN_SERVER_VER_SCALE_ORDERS2 = 40;
	private static final int MIN_SERVER_VER_ALGO_ORDERS = 41;
	private static final int MIN_SERVER_VER_EXECUTION_DATA_CHAIN = 42;
	private static final int MIN_SERVER_VER_NOT_HELD = 44;
	private static final int MIN_SERVER_VER_SEC_ID_TYPE = 45;

	private Socket m_socket;
	private DataOutputStream m_dos; // the socket output stream
	private DataInputStream m_dis;
	private int m_serverVersion;
	private String m_TwsTime;

	public synchronized int serverVersion() throws EException {
		// not connected?
<span class="fc bfc" id="L193" title="All 2 branches covered.">		if (!isConnected()) {</span>
<span class="nc" id="L194">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
		}

<span class="fc" id="L197">		return m_serverVersion;</span>
	}

	public synchronized String TwsConnectionTime() throws EException {
		// not connected?
<span class="fc bfc" id="L202" title="All 2 branches covered.">		if (!isConnected()) {</span>
<span class="nc" id="L203">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
		}

<span class="fc" id="L206">		return m_TwsTime;</span>
	}

	public synchronized boolean isConnected() {
<span class="fc bfc" id="L210" title="All 4 branches covered.">		return m_socket != null &amp;&amp; m_socket.isConnected()</span>
<span class="fc bfc" id="L211" title="All 2 branches covered.">				&amp;&amp; !m_socket.isClosed();</span>
	}

	public synchronized void eConnect(String host, int port, int clientId)
			throws IOException, EException {
<span class="fc bfc" id="L216" title="All 2 branches covered.">		if (isConnected()) {</span>
<span class="fc" id="L217">			throw createEException(NO_VALID_ID, ALREADY_CONNECTED);</span>
		}

<span class="fc" id="L220">		m_socket = createSocket(host, port);</span>
<span class="fc" id="L221">		m_dis = createDataInputStream(m_socket);</span>
<span class="fc" id="L222">		m_dos = createDataOutputStream(m_socket);</span>

<span class="fc" id="L224">		send(CLIENT_VERSION);</span>
<span class="fc" id="L225">		m_serverVersion = readInt(m_dis);</span>

<span class="fc bfc" id="L227" title="All 2 branches covered.">		if (m_serverVersion &lt; SERVER_VERSION) {</span>
<span class="fc" id="L228">			throw createEException(NO_VALID_ID, UPDATE_TWS);</span>
		}
<span class="pc bpc" id="L230" title="1 of 2 branches missed.">		if (m_serverVersion &gt;= 20) {</span>
<span class="fc" id="L231">			m_TwsTime = readStr(m_dis);</span>
		}

		// Send the client id
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">		if (m_serverVersion &gt;= 3) {</span>
<span class="fc" id="L236">			send(clientId);</span>
		}
<span class="fc" id="L238">	}</span>

	EException createEException(int id, CodeMsgPair codeMsgPair) {
<span class="fc" id="L241">		return new EException(id, codeMsgPair);</span>
	}

	public synchronized void eDisconnect() throws IOException {
<span class="fc" id="L245">		Socket socket = m_socket;</span>

<span class="fc" id="L247">		m_socket = null;</span>
<span class="fc" id="L248">		m_dis = null;</span>
<span class="fc" id="L249">		m_dos = null;</span>
<span class="fc" id="L250">		m_serverVersion = 0;</span>
<span class="fc" id="L251">		m_TwsTime = null;</span>

<span class="fc bfc" id="L253" title="All 2 branches covered.">		if (socket != null) {</span>
<span class="fc" id="L254">			socket.close();</span>
		}
<span class="fc" id="L256">	}</span>

	public synchronized void cancelScannerSubscription(int tickerId)
			throws IOException, EException {
		// not connected?
<span class="nc bnc" id="L261" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L262">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L263">			return;</span>
		}

<span class="nc bnc" id="L266" title="All 2 branches missed.">		if (m_serverVersion &lt; 24) {</span>
<span class="nc" id="L267">			error(EClientErrors.NO_VALID_ID, EClientErrors.UPDATE_TWS,</span>
					&quot;  It does not support API scanner subscription.&quot;);
<span class="nc" id="L269">			return;</span>
		}

<span class="nc" id="L272">		final int VERSION = 1;</span>

		// send cancel mkt data msg
<span class="nc" id="L275">		send(CANCEL_SCANNER_SUBSCRIPTION);</span>
<span class="nc" id="L276">		send(VERSION);</span>
<span class="nc" id="L277">		send(tickerId);</span>
<span class="nc" id="L278">	}</span>

	public synchronized void reqScannerParameters() throws IOException,
			EException {
		// not connected?
<span class="nc bnc" id="L283" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L284">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L285">			return;</span>
		}

<span class="nc bnc" id="L288" title="All 2 branches missed.">		if (m_serverVersion &lt; 24) {</span>
<span class="nc" id="L289">			error(EClientErrors.NO_VALID_ID, EClientErrors.UPDATE_TWS,</span>
					&quot;  It does not support API scanner subscription.&quot;);
<span class="nc" id="L291">			return;</span>
		}

<span class="nc" id="L294">		final int VERSION = 1;</span>

<span class="nc" id="L296">		send(REQ_SCANNER_PARAMETERS);</span>
<span class="nc" id="L297">		send(VERSION);</span>
<span class="nc" id="L298">	}</span>

	public synchronized void reqScannerSubscription(int tickerId,
			ScannerSubscription subscription) throws IOException, EException {
		// not connected?
<span class="nc bnc" id="L303" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L304">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L305">			return;</span>
		}

<span class="nc bnc" id="L308" title="All 2 branches missed.">		if (m_serverVersion &lt; 24) {</span>
<span class="nc" id="L309">			error(EClientErrors.NO_VALID_ID, EClientErrors.UPDATE_TWS,</span>
					&quot;  It does not support API scanner subscription.&quot;);
<span class="nc" id="L311">			return;</span>
		}

<span class="nc" id="L314">		final int VERSION = 3;</span>

<span class="nc" id="L316">		send(REQ_SCANNER_SUBSCRIPTION);</span>
<span class="nc" id="L317">		send(VERSION);</span>
<span class="nc" id="L318">		send(tickerId);</span>
<span class="nc" id="L319">		sendMax(subscription.numberOfRows());</span>
<span class="nc" id="L320">		send(subscription.instrument());</span>
<span class="nc" id="L321">		send(subscription.locationCode());</span>
<span class="nc" id="L322">		send(subscription.scanCode());</span>
<span class="nc" id="L323">		sendMax(subscription.abovePrice());</span>
<span class="nc" id="L324">		sendMax(subscription.belowPrice());</span>
<span class="nc" id="L325">		sendMax(subscription.aboveVolume());</span>
<span class="nc" id="L326">		sendMax(subscription.marketCapAbove());</span>
<span class="nc" id="L327">		sendMax(subscription.marketCapBelow());</span>
<span class="nc" id="L328">		send(subscription.moodyRatingAbove());</span>
<span class="nc" id="L329">		send(subscription.moodyRatingBelow());</span>
<span class="nc" id="L330">		send(subscription.spRatingAbove());</span>
<span class="nc" id="L331">		send(subscription.spRatingBelow());</span>
<span class="nc" id="L332">		send(subscription.maturityDateAbove());</span>
<span class="nc" id="L333">		send(subscription.maturityDateBelow());</span>
<span class="nc" id="L334">		sendMax(subscription.couponRateAbove());</span>
<span class="nc" id="L335">		sendMax(subscription.couponRateBelow());</span>
<span class="nc" id="L336">		send(subscription.excludeConvertible());</span>
<span class="nc bnc" id="L337" title="All 2 branches missed.">		if (m_serverVersion &gt;= 25) {</span>
<span class="nc" id="L338">			send(subscription.averageOptionVolumeAbove());</span>
<span class="nc" id="L339">			send(subscription.scannerSettingPairs());</span>
		}
<span class="nc bnc" id="L341" title="All 2 branches missed.">		if (m_serverVersion &gt;= 27) {</span>
<span class="nc" id="L342">			send(subscription.stockTypeFilter());</span>
		}
<span class="nc" id="L344">	}</span>

	public synchronized void reqMktData(int tickerId, Contract contract,
			String genericTickList, boolean snapshot) throws IOException,
			EException {
		// not connected?
<span class="nc bnc" id="L350" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L351">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L352">			return;</span>
		}

<span class="nc bnc" id="L355" title="All 4 branches missed.">		if (m_serverVersion &lt; MIN_SERVER_VER_SNAPSHOT_MKT_DATA &amp;&amp; snapshot) {</span>
<span class="nc" id="L356">			error(tickerId, EClientErrors.UPDATE_TWS,</span>
					&quot;  It does not support snapshot market data requests.&quot;);
<span class="nc" id="L358">			return;</span>
		}

<span class="nc bnc" id="L361" title="All 2 branches missed.">		if (m_serverVersion &lt; MIN_SERVER_VER_UNDER_COMP) {</span>
<span class="nc bnc" id="L362" title="All 2 branches missed.">			if (contract.m_underComp != null) {</span>
<span class="nc" id="L363">				error(tickerId, EClientErrors.UPDATE_TWS,</span>
						&quot;  It does not support delta-neutral orders.&quot;);
<span class="nc" id="L365">				return;</span>
			}
		}

<span class="nc" id="L369">		final int VERSION = 8;</span>

		// send req mkt data msg
<span class="nc" id="L372">		send(REQ_MKT_DATA);</span>
<span class="nc" id="L373">		send(VERSION);</span>
<span class="nc" id="L374">		send(tickerId);</span>

		// send contract fields
<span class="nc" id="L377">		send(contract.m_symbol);</span>
<span class="nc" id="L378">		send(contract.m_secType);</span>
<span class="nc" id="L379">		send(contract.m_expiry);</span>
<span class="nc" id="L380">		send(contract.m_strike);</span>
<span class="nc" id="L381">		send(contract.m_right);</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">		if (m_serverVersion &gt;= 15) {</span>
<span class="nc" id="L383">			send(contract.m_multiplier);</span>
		}
<span class="nc" id="L385">		send(contract.m_exchange);</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">		if (m_serverVersion &gt;= 14) {</span>
<span class="nc" id="L387">			send(contract.m_primaryExch);</span>
		}
<span class="nc" id="L389">		send(contract.m_currency);</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">		if (m_serverVersion &gt;= 2) {</span>
<span class="nc" id="L391">			send(contract.m_localSymbol);</span>
		}
<span class="nc bnc" id="L393" title="All 2 branches missed.">		if (m_serverVersion &gt;= 8</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">				&amp;&amp; BAG_SEC_TYPE.equalsIgnoreCase(contract.m_secType)) {</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">			if (contract.m_comboLegs == null) {</span>
<span class="nc" id="L396">				send(0);</span>
			} else {
<span class="nc" id="L398">				send(contract.m_comboLegs.size());</span>

				ComboLeg comboLeg;
<span class="nc bnc" id="L401" title="All 2 branches missed.">				for (int i = 0; i &lt; contract.m_comboLegs.size(); i++) {</span>
<span class="nc" id="L402">					comboLeg = (ComboLeg) contract.m_comboLegs.get(i);</span>
<span class="nc" id="L403">					send(comboLeg.m_conId);</span>
<span class="nc" id="L404">					send(comboLeg.m_ratio);</span>
<span class="nc" id="L405">					send(comboLeg.m_action);</span>
<span class="nc" id="L406">					send(comboLeg.m_exchange);</span>
				}
			}
		}

<span class="nc bnc" id="L411" title="All 2 branches missed.">		if (m_serverVersion &gt;= MIN_SERVER_VER_UNDER_COMP) {</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">			if (contract.m_underComp != null) {</span>
<span class="nc" id="L413">				UnderComp underComp = contract.m_underComp;</span>
<span class="nc" id="L414">				send(true);</span>
<span class="nc" id="L415">				send(underComp.m_conId);</span>
<span class="nc" id="L416">				send(underComp.m_delta);</span>
<span class="nc" id="L417">				send(underComp.m_price);</span>
<span class="nc" id="L418">			} else {</span>
<span class="nc" id="L419">				send(false);</span>
			}
		}

<span class="nc bnc" id="L423" title="All 2 branches missed.">		if (m_serverVersion &gt;= 31) {</span>
			/*
			 * Note: Even though SHORTABLE tick type supported only starting
			 * server version 33 it would be relatively expensive to expose this
			 * restriction here.
			 * 
			 * Therefore we are relying on TWS doing validation.
			 */
<span class="nc" id="L431">			send(genericTickList);</span>
		}
<span class="nc bnc" id="L433" title="All 2 branches missed.">		if (m_serverVersion &gt;= MIN_SERVER_VER_SNAPSHOT_MKT_DATA) {</span>
<span class="nc" id="L434">			send(snapshot);</span>
		}
<span class="nc" id="L436">	}</span>

	public synchronized void cancelHistoricalData(int tickerId)
			throws IOException, EException {
		// not connected?
<span class="nc bnc" id="L441" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L442">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L443">			return;</span>
		}

<span class="nc bnc" id="L446" title="All 2 branches missed.">		if (m_serverVersion &lt; 24) {</span>
<span class="nc" id="L447">			error(EClientErrors.NO_VALID_ID, EClientErrors.UPDATE_TWS,</span>
					&quot;  It does not support historical data query cancellation.&quot;);
<span class="nc" id="L449">			return;</span>
		}

<span class="nc" id="L452">		final int VERSION = 1;</span>

		// send cancel mkt data msg
<span class="nc" id="L455">		send(CANCEL_HISTORICAL_DATA);</span>
<span class="nc" id="L456">		send(VERSION);</span>
<span class="nc" id="L457">		send(tickerId);</span>
<span class="nc" id="L458">	}</span>

	public synchronized void cancelRealTimeBars(int tickerId)
			throws IOException, EException {
		// not connected?
<span class="nc bnc" id="L463" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L464">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L465">			return;</span>
		}

<span class="nc bnc" id="L468" title="All 2 branches missed.">		if (m_serverVersion &lt; MIN_SERVER_VER_REAL_TIME_BARS) {</span>
<span class="nc" id="L469">			error(EClientErrors.NO_VALID_ID, EClientErrors.UPDATE_TWS,</span>
					&quot;  It does not support realtime bar data query cancellation.&quot;);
<span class="nc" id="L471">			return;</span>
		}

<span class="nc" id="L474">		final int VERSION = 1;</span>

		// send cancel mkt data msg
<span class="nc" id="L477">		send(CANCEL_REAL_TIME_BARS);</span>
<span class="nc" id="L478">		send(VERSION);</span>
<span class="nc" id="L479">		send(tickerId);</span>
<span class="nc" id="L480">	}</span>

	public synchronized void reqHistoricalData(int tickerId, Contract contract,
			String endDateTime, String durationStr, String barSizeSetting,
			String whatToShow, int useRTH, int formatDate) throws IOException,
			EException {
		// not connected?
<span class="nc bnc" id="L487" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L488">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L489">			return;</span>
		}

<span class="nc" id="L492">		final int VERSION = 4;</span>

<span class="nc bnc" id="L494" title="All 2 branches missed.">		if (m_serverVersion &lt; 16) {</span>
<span class="nc" id="L495">			error(EClientErrors.NO_VALID_ID, EClientErrors.UPDATE_TWS,</span>
					&quot;  It does not support historical data backfill.&quot;);
<span class="nc" id="L497">			return;</span>
		}

<span class="nc" id="L500">		send(REQ_HISTORICAL_DATA);</span>
<span class="nc" id="L501">		send(VERSION);</span>
<span class="nc" id="L502">		send(tickerId);</span>

		// send contract fields
<span class="nc" id="L505">		send(contract.m_symbol);</span>
<span class="nc" id="L506">		send(contract.m_secType);</span>
<span class="nc" id="L507">		send(contract.m_expiry);</span>
<span class="nc" id="L508">		send(contract.m_strike);</span>
<span class="nc" id="L509">		send(contract.m_right);</span>
<span class="nc" id="L510">		send(contract.m_multiplier);</span>
<span class="nc" id="L511">		send(contract.m_exchange);</span>
<span class="nc" id="L512">		send(contract.m_primaryExch);</span>
<span class="nc" id="L513">		send(contract.m_currency);</span>
<span class="nc" id="L514">		send(contract.m_localSymbol);</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">		if (m_serverVersion &gt;= 31) {</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">			send(contract.m_includeExpired ? 1 : 0);</span>
		}
<span class="nc bnc" id="L518" title="All 2 branches missed.">		if (m_serverVersion &gt;= 20) {</span>
<span class="nc" id="L519">			send(endDateTime);</span>
<span class="nc" id="L520">			send(barSizeSetting);</span>
		}
<span class="nc" id="L522">		send(durationStr);</span>
<span class="nc" id="L523">		send(useRTH);</span>
<span class="nc" id="L524">		send(whatToShow);</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">		if (m_serverVersion &gt; 16) {</span>
<span class="nc" id="L526">			send(formatDate);</span>
		}
<span class="nc bnc" id="L528" title="All 2 branches missed.">		if (BAG_SEC_TYPE.equalsIgnoreCase(contract.m_secType)) {</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">			if (contract.m_comboLegs == null) {</span>
<span class="nc" id="L530">				send(0);</span>
			} else {
<span class="nc" id="L532">				send(contract.m_comboLegs.size());</span>

				ComboLeg comboLeg;
<span class="nc bnc" id="L535" title="All 2 branches missed.">				for (int i = 0; i &lt; contract.m_comboLegs.size(); i++) {</span>
<span class="nc" id="L536">					comboLeg = (ComboLeg) contract.m_comboLegs.get(i);</span>
<span class="nc" id="L537">					send(comboLeg.m_conId);</span>
<span class="nc" id="L538">					send(comboLeg.m_ratio);</span>
<span class="nc" id="L539">					send(comboLeg.m_action);</span>
<span class="nc" id="L540">					send(comboLeg.m_exchange);</span>
				}
			}
		}
<span class="nc" id="L544">	}</span>

	public synchronized void reqRealTimeBars(int tickerId, Contract contract,
			int barSize, String whatToShow, boolean useRTH) throws IOException,
			EException {
		// not connected?
<span class="nc bnc" id="L550" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L551">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L552">			return;</span>
		}

<span class="nc bnc" id="L555" title="All 2 branches missed.">		if (m_serverVersion &lt; MIN_SERVER_VER_REAL_TIME_BARS) {</span>
<span class="nc" id="L556">			error(EClientErrors.NO_VALID_ID, EClientErrors.UPDATE_TWS,</span>
					&quot;  It does not support real time bars.&quot;);
<span class="nc" id="L558">			return;</span>
		}

<span class="nc" id="L561">		final int VERSION = 1;</span>

		// send req mkt data msg
<span class="nc" id="L564">		send(REQ_REAL_TIME_BARS);</span>
<span class="nc" id="L565">		send(VERSION);</span>
<span class="nc" id="L566">		send(tickerId);</span>

		// send contract fields
<span class="nc" id="L569">		send(contract.m_symbol);</span>
<span class="nc" id="L570">		send(contract.m_secType);</span>
<span class="nc" id="L571">		send(contract.m_expiry);</span>
<span class="nc" id="L572">		send(contract.m_strike);</span>
<span class="nc" id="L573">		send(contract.m_right);</span>
<span class="nc" id="L574">		send(contract.m_multiplier);</span>
<span class="nc" id="L575">		send(contract.m_exchange);</span>
<span class="nc" id="L576">		send(contract.m_primaryExch);</span>
<span class="nc" id="L577">		send(contract.m_currency);</span>
<span class="nc" id="L578">		send(contract.m_localSymbol);</span>
<span class="nc" id="L579">		send(barSize);</span>
<span class="nc" id="L580">		send(whatToShow);</span>
<span class="nc" id="L581">		send(useRTH);</span>
<span class="nc" id="L582">	}</span>

	public synchronized void reqContractDetails(int reqId, Contract contract)
			throws IOException, EException {
		// not connected?
<span class="nc bnc" id="L587" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L588">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L589">			return;</span>
		}

		// This feature is only available for versions of TWS &gt;=4
<span class="nc bnc" id="L593" title="All 2 branches missed.">		if (m_serverVersion &lt; 4) {</span>
<span class="nc" id="L594">			error(EClientErrors.NO_VALID_ID, EClientErrors.UPDATE_TWS.code(),</span>
<span class="nc" id="L595">					EClientErrors.UPDATE_TWS.msg());</span>
<span class="nc" id="L596">			return;</span>
		}

<span class="nc bnc" id="L599" title="All 2 branches missed.">		if (m_serverVersion &lt; MIN_SERVER_VER_SEC_ID_TYPE) {</span>
<span class="nc bnc" id="L600" title="All 4 branches missed.">			if (!IsEmpty(contract.m_secIdType) || !IsEmpty(contract.m_secId)) {</span>
<span class="nc" id="L601">				error(reqId, EClientErrors.UPDATE_TWS,</span>
						&quot;  It does not support secIdType and secId parameters.&quot;);
<span class="nc" id="L603">				return;</span>
			}
		}

<span class="nc" id="L607">		final int VERSION = 6;</span>

		// send req mkt data msg
<span class="nc" id="L610">		send(REQ_CONTRACT_DATA);</span>
<span class="nc" id="L611">		send(VERSION);</span>

<span class="nc bnc" id="L613" title="All 2 branches missed.">		if (m_serverVersion &gt;= MIN_SERVER_VER_CONTRACT_DATA_CHAIN) {</span>
<span class="nc" id="L614">			send(reqId);</span>
		}

		// send contract fields
<span class="nc bnc" id="L618" title="All 2 branches missed.">		if (m_serverVersion &gt;= MIN_SERVER_VER_CONTRACT_CONID) {</span>
<span class="nc" id="L619">			send(contract.m_conId);</span>
		}
<span class="nc" id="L621">		send(contract.m_symbol);</span>
<span class="nc" id="L622">		send(contract.m_secType);</span>
<span class="nc" id="L623">		send(contract.m_expiry);</span>
<span class="nc" id="L624">		send(contract.m_strike);</span>
<span class="nc" id="L625">		send(contract.m_right);</span>
<span class="nc bnc" id="L626" title="All 2 branches missed.">		if (m_serverVersion &gt;= 15) {</span>
<span class="nc" id="L627">			send(contract.m_multiplier);</span>
		}
<span class="nc" id="L629">		send(contract.m_exchange);</span>
<span class="nc" id="L630">		send(contract.m_currency);</span>
<span class="nc" id="L631">		send(contract.m_localSymbol);</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">		if (m_serverVersion &gt;= 31) {</span>
<span class="nc" id="L633">			send(contract.m_includeExpired);</span>
		}
<span class="nc bnc" id="L635" title="All 2 branches missed.">		if (m_serverVersion &gt;= MIN_SERVER_VER_SEC_ID_TYPE) {</span>
<span class="nc" id="L636">			send(contract.m_secIdType);</span>
<span class="nc" id="L637">			send(contract.m_secId);</span>
		}
<span class="nc" id="L639">	}</span>

	public synchronized void reqMktDepth(int tickerId, Contract contract,
			int numRows) throws IOException, EException {
		// not connected?
<span class="nc bnc" id="L644" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L645">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L646">			return;</span>
		}

		// This feature is only available for versions of TWS &gt;=6
<span class="nc bnc" id="L650" title="All 2 branches missed.">		if (m_serverVersion &lt; 6) {</span>
<span class="nc" id="L651">			error(EClientErrors.NO_VALID_ID, EClientErrors.UPDATE_TWS.code(),</span>
<span class="nc" id="L652">					EClientErrors.UPDATE_TWS.msg());</span>
<span class="nc" id="L653">			return;</span>
		}

<span class="nc" id="L656">		final int VERSION = 3;</span>

		// send req mkt data msg
<span class="nc" id="L659">		send(REQ_MKT_DEPTH);</span>
<span class="nc" id="L660">		send(VERSION);</span>
<span class="nc" id="L661">		send(tickerId);</span>

		// send contract fields
<span class="nc" id="L664">		send(contract.m_symbol);</span>
<span class="nc" id="L665">		send(contract.m_secType);</span>
<span class="nc" id="L666">		send(contract.m_expiry);</span>
<span class="nc" id="L667">		send(contract.m_strike);</span>
<span class="nc" id="L668">		send(contract.m_right);</span>
<span class="nc bnc" id="L669" title="All 2 branches missed.">		if (m_serverVersion &gt;= 15) {</span>
<span class="nc" id="L670">			send(contract.m_multiplier);</span>
		}
<span class="nc" id="L672">		send(contract.m_exchange);</span>
<span class="nc" id="L673">		send(contract.m_currency);</span>
<span class="nc" id="L674">		send(contract.m_localSymbol);</span>
<span class="nc bnc" id="L675" title="All 2 branches missed.">		if (m_serverVersion &gt;= 19) {</span>
<span class="nc" id="L676">			send(numRows);</span>
		}
<span class="nc" id="L678">	}</span>

	public synchronized void cancelMktData(int tickerId) throws IOException,
			EException {
		// not connected?
<span class="nc bnc" id="L683" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L684">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L685">			return;</span>
		}

<span class="nc" id="L688">		final int VERSION = 1;</span>

		// send cancel mkt data msg
<span class="nc" id="L691">		send(CANCEL_MKT_DATA);</span>
<span class="nc" id="L692">		send(VERSION);</span>
<span class="nc" id="L693">		send(tickerId);</span>
<span class="nc" id="L694">	}</span>

	public synchronized void cancelMktDepth(int tickerId) throws IOException,
			EException {
		// not connected?
<span class="nc bnc" id="L699" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L700">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L701">			return;</span>
		}

		// This feature is only available for versions of TWS &gt;=6
<span class="nc bnc" id="L705" title="All 2 branches missed.">		if (m_serverVersion &lt; 6) {</span>
<span class="nc" id="L706">			error(EClientErrors.NO_VALID_ID, EClientErrors.UPDATE_TWS.code(),</span>
<span class="nc" id="L707">					EClientErrors.UPDATE_TWS.msg());</span>
<span class="nc" id="L708">			return;</span>
		}

<span class="nc" id="L711">		final int VERSION = 1;</span>

		// send cancel mkt data msg
<span class="nc" id="L714">		send(CANCEL_MKT_DEPTH);</span>
<span class="nc" id="L715">		send(VERSION);</span>
<span class="nc" id="L716">		send(tickerId);</span>
<span class="nc" id="L717">	}</span>

	public synchronized void exerciseOptions(int tickerId, Contract contract,
			int exerciseAction, int exerciseQuantity, String account,
			int override) throws IOException, EException {
		// not connected?
<span class="nc bnc" id="L723" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L724">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L725">			return;</span>
		}

<span class="nc" id="L728">		final int VERSION = 1;</span>

<span class="nc bnc" id="L730" title="All 2 branches missed.">		if (m_serverVersion &lt; 21) {</span>
<span class="nc" id="L731">			error(EClientErrors.NO_VALID_ID, EClientErrors.UPDATE_TWS,</span>
					&quot;  It does not support options exercise from the API.&quot;);
<span class="nc" id="L733">			return;</span>
		}

<span class="nc" id="L736">		send(EXERCISE_OPTIONS);</span>
<span class="nc" id="L737">		send(VERSION);</span>
<span class="nc" id="L738">		send(tickerId);</span>

		// send contract fields
<span class="nc" id="L741">		send(contract.m_symbol);</span>
<span class="nc" id="L742">		send(contract.m_secType);</span>
<span class="nc" id="L743">		send(contract.m_expiry);</span>
<span class="nc" id="L744">		send(contract.m_strike);</span>
<span class="nc" id="L745">		send(contract.m_right);</span>
<span class="nc" id="L746">		send(contract.m_multiplier);</span>
<span class="nc" id="L747">		send(contract.m_exchange);</span>
<span class="nc" id="L748">		send(contract.m_currency);</span>
<span class="nc" id="L749">		send(contract.m_localSymbol);</span>
<span class="nc" id="L750">		send(exerciseAction);</span>
<span class="nc" id="L751">		send(exerciseQuantity);</span>
<span class="nc" id="L752">		send(account);</span>
<span class="nc" id="L753">		send(override);</span>
<span class="nc" id="L754">	}</span>

	public synchronized void placeOrder(int id, Contract contract, Order order)
			throws IOException, EException {
		// not connected?
<span class="nc bnc" id="L759" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L760">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L761">			return;</span>
		}

<span class="nc bnc" id="L764" title="All 2 branches missed.">		if (m_serverVersion &lt; MIN_SERVER_VER_SCALE_ORDERS) {</span>
<span class="nc bnc" id="L765" title="All 4 branches missed.">			if (order.m_scaleInitLevelSize != Integer.MAX_VALUE</span>
					|| order.m_scalePriceIncrement != Double.MAX_VALUE) {
<span class="nc" id="L767">				error(id, EClientErrors.UPDATE_TWS,</span>
						&quot;  It does not support Scale orders.&quot;);
<span class="nc" id="L769">				return;</span>
			}
		}

<span class="nc bnc" id="L773" title="All 2 branches missed.">		if (m_serverVersion &lt; MIN_SERVER_VER_SSHORT_COMBO_LEGS) {</span>
<span class="nc bnc" id="L774" title="All 2 branches missed.">			if (!contract.m_comboLegs.isEmpty()) {</span>
				ComboLeg comboLeg;
<span class="nc bnc" id="L776" title="All 2 branches missed.">				for (int i = 0; i &lt; contract.m_comboLegs.size(); ++i) {</span>
<span class="nc" id="L777">					comboLeg = (ComboLeg) contract.m_comboLegs.get(i);</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">					if (comboLeg.m_shortSaleSlot != 0</span>
<span class="nc bnc" id="L779" title="All 2 branches missed.">							|| !IsEmpty(comboLeg.m_designatedLocation)) {</span>
<span class="nc" id="L780">						error(id, EClientErrors.UPDATE_TWS,</span>
								&quot;  It does not support SSHORT flag for combo legs.&quot;);
<span class="nc" id="L782">						return;</span>
					}
				}
			}
		}

<span class="nc bnc" id="L788" title="All 2 branches missed.">		if (m_serverVersion &lt; MIN_SERVER_VER_WHAT_IF_ORDERS) {</span>
<span class="nc bnc" id="L789" title="All 2 branches missed.">			if (order.m_whatIf) {</span>
<span class="nc" id="L790">				error(id, EClientErrors.UPDATE_TWS,</span>
						&quot;  It does not support what-if orders.&quot;);
<span class="nc" id="L792">				return;</span>
			}
		}

<span class="nc bnc" id="L796" title="All 2 branches missed.">		if (m_serverVersion &lt; MIN_SERVER_VER_UNDER_COMP) {</span>
<span class="nc bnc" id="L797" title="All 2 branches missed.">			if (contract.m_underComp != null) {</span>
<span class="nc" id="L798">				error(id, EClientErrors.UPDATE_TWS,</span>
						&quot;  It does not support delta-neutral orders.&quot;);
<span class="nc" id="L800">				return;</span>
			}
		}

<span class="nc bnc" id="L804" title="All 2 branches missed.">		if (m_serverVersion &lt; MIN_SERVER_VER_SCALE_ORDERS2) {</span>
<span class="nc bnc" id="L805" title="All 2 branches missed.">			if (order.m_scaleSubsLevelSize != Integer.MAX_VALUE) {</span>
<span class="nc" id="L806">				error(id, EClientErrors.UPDATE_TWS,</span>
						&quot;  It does not support Subsequent Level Size for Scale orders.&quot;);
<span class="nc" id="L808">				return;</span>
			}
		}

<span class="nc bnc" id="L812" title="All 2 branches missed.">		if (m_serverVersion &lt; MIN_SERVER_VER_ALGO_ORDERS) {</span>
<span class="nc bnc" id="L813" title="All 2 branches missed.">			if (!IsEmpty(order.m_algoStrategy)) {</span>
<span class="nc" id="L814">				error(id, EClientErrors.UPDATE_TWS,</span>
						&quot;  It does not support algo orders.&quot;);
<span class="nc" id="L816">				return;</span>
			}
		}

<span class="nc bnc" id="L820" title="All 2 branches missed.">		if (m_serverVersion &lt; MIN_SERVER_VER_NOT_HELD) {</span>
<span class="nc bnc" id="L821" title="All 2 branches missed.">			if (order.m_notHeld) {</span>
<span class="nc" id="L822">				error(id, EClientErrors.UPDATE_TWS,</span>
						&quot;  It does not support notHeld parameter.&quot;);
<span class="nc" id="L824">				return;</span>
			}
		}

<span class="nc bnc" id="L828" title="All 2 branches missed.">		if (m_serverVersion &lt; MIN_SERVER_VER_SEC_ID_TYPE) {</span>
<span class="nc bnc" id="L829" title="All 4 branches missed.">			if (!IsEmpty(contract.m_secIdType) || !IsEmpty(contract.m_secId)) {</span>
<span class="nc" id="L830">				error(id, EClientErrors.UPDATE_TWS,</span>
						&quot;  It does not support secIdType and secId parameters.&quot;);
<span class="nc" id="L832">				return;</span>
			}
		}

<span class="nc bnc" id="L836" title="All 2 branches missed.">		int VERSION = (m_serverVersion &lt; MIN_SERVER_VER_NOT_HELD) ? 27 : 29;</span>

		// send place order msg
<span class="nc" id="L839">		send(PLACE_ORDER);</span>
<span class="nc" id="L840">		send(VERSION);</span>
<span class="nc" id="L841">		send(id);</span>

		// send contract fields
<span class="nc" id="L844">		send(contract.m_symbol);</span>
<span class="nc" id="L845">		send(contract.m_secType);</span>
<span class="nc" id="L846">		send(contract.m_expiry);</span>
<span class="nc" id="L847">		send(contract.m_strike);</span>
<span class="nc" id="L848">		send(contract.m_right);</span>
<span class="nc bnc" id="L849" title="All 2 branches missed.">		if (m_serverVersion &gt;= 15) {</span>
<span class="nc" id="L850">			send(contract.m_multiplier);</span>
		}
<span class="nc" id="L852">		send(contract.m_exchange);</span>
<span class="nc bnc" id="L853" title="All 2 branches missed.">		if (m_serverVersion &gt;= 14) {</span>
<span class="nc" id="L854">			send(contract.m_primaryExch);</span>
		}
<span class="nc" id="L856">		send(contract.m_currency);</span>
<span class="nc bnc" id="L857" title="All 2 branches missed.">		if (m_serverVersion &gt;= 2) {</span>
<span class="nc" id="L858">			send(contract.m_localSymbol);</span>
		}
<span class="nc bnc" id="L860" title="All 2 branches missed.">		if (m_serverVersion &gt;= MIN_SERVER_VER_SEC_ID_TYPE) {</span>
<span class="nc" id="L861">			send(contract.m_secIdType);</span>
<span class="nc" id="L862">			send(contract.m_secId);</span>
		}

		// send main order fields
<span class="nc" id="L866">		send(order.m_action);</span>
<span class="nc" id="L867">		send(order.m_totalQuantity);</span>
<span class="nc" id="L868">		send(order.m_orderType);</span>
<span class="nc" id="L869">		send(order.m_lmtPrice);</span>
<span class="nc" id="L870">		send(order.m_auxPrice);</span>

		// send extended order fields
<span class="nc" id="L873">		send(order.m_tif);</span>
<span class="nc" id="L874">		send(order.m_ocaGroup);</span>
<span class="nc" id="L875">		send(order.m_account);</span>
<span class="nc" id="L876">		send(order.m_openClose);</span>
<span class="nc" id="L877">		send(order.m_origin);</span>
<span class="nc" id="L878">		send(order.m_orderRef);</span>
<span class="nc" id="L879">		send(order.m_transmit);</span>
<span class="nc bnc" id="L880" title="All 2 branches missed.">		if (m_serverVersion &gt;= 4) {</span>
<span class="nc" id="L881">			send(order.m_parentId);</span>
		}

<span class="nc bnc" id="L884" title="All 2 branches missed.">		if (m_serverVersion &gt;= 5) {</span>
<span class="nc" id="L885">			send(order.m_blockOrder);</span>
<span class="nc" id="L886">			send(order.m_sweepToFill);</span>
<span class="nc" id="L887">			send(order.m_displaySize);</span>
<span class="nc" id="L888">			send(order.m_triggerMethod);</span>
<span class="nc bnc" id="L889" title="All 2 branches missed.">			if (m_serverVersion &lt; 38) {</span>
				// will never happen
<span class="nc" id="L891">				send(/* order.m_ignoreRth */false);</span>
			} else {
<span class="nc" id="L893">				send(order.m_outsideRth);</span>
			}
		}

<span class="nc bnc" id="L897" title="All 2 branches missed.">		if (m_serverVersion &gt;= 7) {</span>
<span class="nc" id="L898">			send(order.m_hidden);</span>
		}

		// Send combo legs for BAG requests
<span class="nc bnc" id="L902" title="All 2 branches missed.">		if (m_serverVersion &gt;= 8</span>
<span class="nc bnc" id="L903" title="All 2 branches missed.">				&amp;&amp; BAG_SEC_TYPE.equalsIgnoreCase(contract.m_secType)) {</span>
<span class="nc bnc" id="L904" title="All 2 branches missed.">			if (contract.m_comboLegs == null) {</span>
<span class="nc" id="L905">				send(0);</span>
			} else {
<span class="nc" id="L907">				send(contract.m_comboLegs.size());</span>

				ComboLeg comboLeg;
<span class="nc bnc" id="L910" title="All 2 branches missed.">				for (int i = 0; i &lt; contract.m_comboLegs.size(); i++) {</span>
<span class="nc" id="L911">					comboLeg = (ComboLeg) contract.m_comboLegs.get(i);</span>
<span class="nc" id="L912">					send(comboLeg.m_conId);</span>
<span class="nc" id="L913">					send(comboLeg.m_ratio);</span>
<span class="nc" id="L914">					send(comboLeg.m_action);</span>
<span class="nc" id="L915">					send(comboLeg.m_exchange);</span>
<span class="nc" id="L916">					send(comboLeg.m_openClose);</span>

<span class="nc bnc" id="L918" title="All 2 branches missed.">					if (m_serverVersion &gt;= MIN_SERVER_VER_SSHORT_COMBO_LEGS) {</span>
<span class="nc" id="L919">						send(comboLeg.m_shortSaleSlot);</span>
<span class="nc" id="L920">						send(comboLeg.m_designatedLocation);</span>
					}
				}
			}
		}

<span class="nc bnc" id="L926" title="All 2 branches missed.">		if (m_serverVersion &gt;= 9) {</span>
			// send deprecated sharesAllocation field
<span class="nc" id="L928">			send(&quot;&quot;);</span>
		}

<span class="nc bnc" id="L931" title="All 2 branches missed.">		if (m_serverVersion &gt;= 10) {</span>
<span class="nc" id="L932">			send(order.m_discretionaryAmt);</span>
		}

<span class="nc bnc" id="L935" title="All 2 branches missed.">		if (m_serverVersion &gt;= 11) {</span>
<span class="nc" id="L936">			send(order.m_goodAfterTime);</span>
		}

<span class="nc bnc" id="L939" title="All 2 branches missed.">		if (m_serverVersion &gt;= 12) {</span>
<span class="nc" id="L940">			send(order.m_goodTillDate);</span>
		}

<span class="nc bnc" id="L943" title="All 2 branches missed.">		if (m_serverVersion &gt;= 13) {</span>
<span class="nc" id="L944">			send(order.m_faGroup);</span>
<span class="nc" id="L945">			send(order.m_faMethod);</span>
<span class="nc" id="L946">			send(order.m_faPercentage);</span>
<span class="nc" id="L947">			send(order.m_faProfile);</span>
		}
<span class="nc bnc" id="L949" title="All 2 branches missed.">		if (m_serverVersion &gt;= 18) { // institutional short sale slot</span>
			// fields.
<span class="nc" id="L951">			send(order.m_shortSaleSlot); // 0 only for retail, 1 or 2 only</span>
			// for institution.
<span class="nc" id="L953">			send(order.m_designatedLocation); // only populate when</span>
			// order.m_shortSaleSlot =
			// 2.
		}
<span class="nc bnc" id="L957" title="All 2 branches missed.">		if (m_serverVersion &gt;= 19) {</span>
<span class="nc" id="L958">			send(order.m_ocaType);</span>
<span class="nc bnc" id="L959" title="All 2 branches missed.">			if (m_serverVersion &lt; 38) {</span>
				// will never happen
<span class="nc" id="L961">				send( /* order.m_rthOnly */false);</span>
			}
<span class="nc" id="L963">			send(order.m_rule80A);</span>
<span class="nc" id="L964">			send(order.m_settlingFirm);</span>
<span class="nc" id="L965">			send(order.m_allOrNone);</span>
<span class="nc" id="L966">			sendMax(order.m_minQty);</span>
<span class="nc" id="L967">			sendMax(order.m_percentOffset);</span>
<span class="nc" id="L968">			send(order.m_eTradeOnly);</span>
<span class="nc" id="L969">			send(order.m_firmQuoteOnly);</span>
<span class="nc" id="L970">			sendMax(order.m_nbboPriceCap);</span>
<span class="nc" id="L971">			sendMax(order.m_auctionStrategy);</span>
<span class="nc" id="L972">			sendMax(order.m_startingPrice);</span>
<span class="nc" id="L973">			sendMax(order.m_stockRefPrice);</span>
<span class="nc" id="L974">			sendMax(order.m_delta);</span>
			// Volatility orders had specific watermark price attribs in
			// server version 26
<span class="nc bnc" id="L977" title="All 2 branches missed.">			double lower = (m_serverVersion == 26 &amp;&amp; order.m_orderType</span>
<span class="nc bnc" id="L978" title="All 2 branches missed.">					.equals(&quot;VOL&quot;)) ? Double.MAX_VALUE</span>
					: order.m_stockRangeLower;
<span class="nc bnc" id="L980" title="All 2 branches missed.">			double upper = (m_serverVersion == 26 &amp;&amp; order.m_orderType</span>
<span class="nc bnc" id="L981" title="All 2 branches missed.">					.equals(&quot;VOL&quot;)) ? Double.MAX_VALUE</span>
					: order.m_stockRangeUpper;
<span class="nc" id="L983">			sendMax(lower);</span>
<span class="nc" id="L984">			sendMax(upper);</span>
		}

<span class="nc bnc" id="L987" title="All 2 branches missed.">		if (m_serverVersion &gt;= 22) {</span>
<span class="nc" id="L988">			send(order.m_overridePercentageConstraints);</span>
		}

<span class="nc bnc" id="L991" title="All 2 branches missed.">		if (m_serverVersion &gt;= 26) { // Volatility orders</span>
<span class="nc" id="L992">			sendMax(order.m_volatility);</span>
<span class="nc" id="L993">			sendMax(order.m_volatilityType);</span>
<span class="nc bnc" id="L994" title="All 2 branches missed.">			if (m_serverVersion &lt; 28) {</span>
<span class="nc" id="L995">				send(order.m_deltaNeutralOrderType.equalsIgnoreCase(&quot;MKT&quot;));</span>
			} else {
<span class="nc" id="L997">				send(order.m_deltaNeutralOrderType);</span>
<span class="nc" id="L998">				sendMax(order.m_deltaNeutralAuxPrice);</span>
			}
<span class="nc" id="L1000">			send(order.m_continuousUpdate);</span>
<span class="nc bnc" id="L1001" title="All 2 branches missed.">			if (m_serverVersion == 26) {</span>
				// Volatility orders had specific watermark price attribs in
				// server version 26
<span class="nc bnc" id="L1004" title="All 2 branches missed.">				double lower = order.m_orderType.equals(&quot;VOL&quot;) ? order.m_stockRangeLower</span>
						: Double.MAX_VALUE;
<span class="nc bnc" id="L1006" title="All 2 branches missed.">				double upper = order.m_orderType.equals(&quot;VOL&quot;) ? order.m_stockRangeUpper</span>
						: Double.MAX_VALUE;
<span class="nc" id="L1008">				sendMax(lower);</span>
<span class="nc" id="L1009">				sendMax(upper);</span>
			}
<span class="nc" id="L1011">			sendMax(order.m_referencePriceType);</span>
		}

<span class="nc bnc" id="L1014" title="All 2 branches missed.">		if (m_serverVersion &gt;= 30) { // TRAIL_STOP_LIMIT stop price</span>
<span class="nc" id="L1015">			sendMax(order.m_trailStopPrice);</span>
		}

<span class="nc bnc" id="L1018" title="All 2 branches missed.">		if (m_serverVersion &gt;= MIN_SERVER_VER_SCALE_ORDERS) {</span>
<span class="nc bnc" id="L1019" title="All 2 branches missed.">			if (m_serverVersion &gt;= MIN_SERVER_VER_SCALE_ORDERS2) {</span>
<span class="nc" id="L1020">				sendMax(order.m_scaleInitLevelSize);</span>
<span class="nc" id="L1021">				sendMax(order.m_scaleSubsLevelSize);</span>
			} else {
<span class="nc" id="L1023">				send(&quot;&quot;);</span>
<span class="nc" id="L1024">				sendMax(order.m_scaleInitLevelSize);</span>

			}
<span class="nc" id="L1027">			sendMax(order.m_scalePriceIncrement);</span>
		}

<span class="nc bnc" id="L1030" title="All 2 branches missed.">		if (m_serverVersion &gt;= MIN_SERVER_VER_PTA_ORDERS) {</span>
<span class="nc" id="L1031">			send(order.m_clearingAccount);</span>
<span class="nc" id="L1032">			send(order.m_clearingIntent);</span>
		}

<span class="nc bnc" id="L1035" title="All 2 branches missed.">		if (m_serverVersion &gt;= MIN_SERVER_VER_NOT_HELD) {</span>
<span class="nc" id="L1036">			send(order.m_notHeld);</span>
		}

<span class="nc bnc" id="L1039" title="All 2 branches missed.">		if (m_serverVersion &gt;= MIN_SERVER_VER_UNDER_COMP) {</span>
<span class="nc bnc" id="L1040" title="All 2 branches missed.">			if (contract.m_underComp != null) {</span>
<span class="nc" id="L1041">				UnderComp underComp = contract.m_underComp;</span>
<span class="nc" id="L1042">				send(true);</span>
<span class="nc" id="L1043">				send(underComp.m_conId);</span>
<span class="nc" id="L1044">				send(underComp.m_delta);</span>
<span class="nc" id="L1045">				send(underComp.m_price);</span>
<span class="nc" id="L1046">			} else {</span>
<span class="nc" id="L1047">				send(false);</span>
			}
		}

<span class="nc bnc" id="L1051" title="All 2 branches missed.">		if (m_serverVersion &gt;= MIN_SERVER_VER_ALGO_ORDERS) {</span>
<span class="nc" id="L1052">			send(order.m_algoStrategy);</span>
<span class="nc bnc" id="L1053" title="All 2 branches missed.">			if (!IsEmpty(order.m_algoStrategy)) {</span>
<span class="nc" id="L1054">				java.util.Vector algoParams = order.m_algoParams;</span>
<span class="nc bnc" id="L1055" title="All 2 branches missed.">				int algoParamsCount = algoParams == null ? 0 : algoParams</span>
<span class="nc" id="L1056">						.size();</span>
<span class="nc" id="L1057">				send(algoParamsCount);</span>
<span class="nc bnc" id="L1058" title="All 2 branches missed.">				if (algoParamsCount &gt; 0) {</span>
<span class="nc bnc" id="L1059" title="All 2 branches missed.">					for (int i = 0; i &lt; algoParamsCount; ++i) {</span>
<span class="nc" id="L1060">						TagValue tagValue = (TagValue) algoParams.get(i);</span>
<span class="nc" id="L1061">						send(tagValue.m_tag);</span>
<span class="nc" id="L1062">						send(tagValue.m_value);</span>
					}
				}
			}
		}

<span class="nc bnc" id="L1068" title="All 2 branches missed.">		if (m_serverVersion &gt;= MIN_SERVER_VER_WHAT_IF_ORDERS) {</span>
<span class="nc" id="L1069">			send(order.m_whatIf);</span>
		}
<span class="nc" id="L1071">	}</span>

	public synchronized void reqAccountUpdates(boolean subscribe,
			String acctCode) throws IOException, EException {
		// not connected?
<span class="nc bnc" id="L1076" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L1077">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L1078">			return;</span>
		}

<span class="nc" id="L1081">		final int VERSION = 2;</span>

		// send cancel order msg
<span class="nc" id="L1084">		send(REQ_ACCOUNT_DATA);</span>
<span class="nc" id="L1085">		send(VERSION);</span>
<span class="nc" id="L1086">		send(subscribe);</span>

		// Send the account code. This will only be used for FA clients
<span class="nc bnc" id="L1089" title="All 2 branches missed.">		if (m_serverVersion &gt;= 9) {</span>
<span class="nc" id="L1090">			send(acctCode);</span>
		}
<span class="nc" id="L1092">	}</span>

	public synchronized void reqExecutions(int reqId, ExecutionFilter filter)
			throws IOException, EException {
		// not connected?
<span class="nc bnc" id="L1097" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L1098">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L1099">			return;</span>
		}

<span class="nc" id="L1102">		final int VERSION = 3;</span>

		// send cancel order msg
<span class="nc" id="L1105">		send(REQ_EXECUTIONS);</span>
<span class="nc" id="L1106">		send(VERSION);</span>

<span class="nc bnc" id="L1108" title="All 2 branches missed.">		if (m_serverVersion &gt;= MIN_SERVER_VER_EXECUTION_DATA_CHAIN) {</span>
<span class="nc" id="L1109">			send(reqId);</span>
		}

		// Send the execution rpt filter data
<span class="nc bnc" id="L1113" title="All 2 branches missed.">		if (m_serverVersion &gt;= 9) {</span>
<span class="nc" id="L1114">			send(filter.m_clientId);</span>
<span class="nc" id="L1115">			send(filter.m_acctCode);</span>

			// Note that the valid format for m_time is &quot;yyyymmdd-hh:mm:ss&quot;
<span class="nc" id="L1118">			send(filter.m_time);</span>
<span class="nc" id="L1119">			send(filter.m_symbol);</span>
<span class="nc" id="L1120">			send(filter.m_secType);</span>
<span class="nc" id="L1121">			send(filter.m_exchange);</span>
<span class="nc" id="L1122">			send(filter.m_side);</span>
		}
<span class="nc" id="L1124">	}</span>

	public synchronized void cancelOrder(int id) throws IOException, EException {
		// not connected?
<span class="nc bnc" id="L1128" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L1129">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L1130">			return;</span>
		}

<span class="nc" id="L1133">		final int VERSION = 1;</span>

		// send cancel order msg
<span class="nc" id="L1136">		send(CANCEL_ORDER);</span>
<span class="nc" id="L1137">		send(VERSION);</span>
<span class="nc" id="L1138">		send(id);</span>
<span class="nc" id="L1139">	}</span>

	public synchronized void reqOpenOrders() throws IOException, EException {
		// not connected?
<span class="nc bnc" id="L1143" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L1144">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L1145">			return;</span>
		}

<span class="nc" id="L1148">		final int VERSION = 1;</span>

		// send cancel order msg
<span class="nc" id="L1151">		send(REQ_OPEN_ORDERS);</span>
<span class="nc" id="L1152">		send(VERSION);</span>
<span class="nc" id="L1153">	}</span>

	public synchronized void reqIds(int numIds) throws IOException, EException {
		// not connected?
<span class="nc bnc" id="L1157" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L1158">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L1159">			return;</span>
		}

<span class="nc" id="L1162">		final int VERSION = 1;</span>

<span class="nc" id="L1164">		send(REQ_IDS);</span>
<span class="nc" id="L1165">		send(VERSION);</span>
<span class="nc" id="L1166">		send(numIds);</span>
<span class="nc" id="L1167">	}</span>

	public synchronized void reqNewsBulletins(boolean allMsgs)
			throws IOException, EException {
		// not connected?
<span class="nc bnc" id="L1172" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L1173">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L1174">			return;</span>
		}

<span class="nc" id="L1177">		final int VERSION = 1;</span>

<span class="nc" id="L1179">		send(REQ_NEWS_BULLETINS);</span>
<span class="nc" id="L1180">		send(VERSION);</span>
<span class="nc" id="L1181">		send(allMsgs);</span>
<span class="nc" id="L1182">	}</span>

	public synchronized void cancelNewsBulletins() throws IOException,
			EException {
		// not connected?
<span class="nc bnc" id="L1187" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L1188">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L1189">			return;</span>
		}

<span class="nc" id="L1192">		final int VERSION = 1;</span>

		// send cancel order msg
<span class="nc" id="L1195">		send(CANCEL_NEWS_BULLETINS);</span>
<span class="nc" id="L1196">		send(VERSION);</span>
<span class="nc" id="L1197">	}</span>

	public synchronized void setServerLogLevel(int logLevel)
			throws IOException, EException {
<span class="nc" id="L1201">		final int VERSION = 1;</span>

		// send the set server logging level message
<span class="nc" id="L1204">		send(SET_SERVER_LOGLEVEL);</span>
<span class="nc" id="L1205">		send(VERSION);</span>
<span class="nc" id="L1206">		send(logLevel);</span>
<span class="nc" id="L1207">	}</span>

	public synchronized void reqAutoOpenOrders(boolean bAutoBind)
			throws IOException, EException {
		// not connected?
<span class="nc bnc" id="L1212" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L1213">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L1214">			return;</span>
		}

<span class="nc" id="L1217">		final int VERSION = 1;</span>

		// send req open orders msg
<span class="nc" id="L1220">		send(REQ_AUTO_OPEN_ORDERS);</span>
<span class="nc" id="L1221">		send(VERSION);</span>
<span class="nc" id="L1222">		send(bAutoBind);</span>
<span class="nc" id="L1223">	}</span>

	public synchronized void reqAllOpenOrders() throws IOException, EException {
		// not connected?
<span class="nc bnc" id="L1227" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L1228">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L1229">			return;</span>
		}

<span class="nc" id="L1232">		final int VERSION = 1;</span>

		// send req all open orders msg
<span class="nc" id="L1235">		send(REQ_ALL_OPEN_ORDERS);</span>
<span class="nc" id="L1236">		send(VERSION);</span>
<span class="nc" id="L1237">	}</span>

	public synchronized void reqManagedAccts() throws IOException, EException {
		// not connected?
<span class="nc bnc" id="L1241" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L1242">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L1243">			return;</span>
		}

<span class="nc" id="L1246">		final int VERSION = 1;</span>

		// send req FA managed accounts msg
<span class="nc" id="L1249">		send(REQ_MANAGED_ACCTS);</span>
<span class="nc" id="L1250">		send(VERSION);</span>
<span class="nc" id="L1251">	}</span>

	public synchronized void requestFA(int faDataType) throws IOException,
			EException {
		// not connected?
<span class="nc bnc" id="L1256" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L1257">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L1258">			return;</span>
		}

		// This feature is only available for versions of TWS &gt;= 13
<span class="nc bnc" id="L1262" title="All 2 branches missed.">		if (m_serverVersion &lt; 13) {</span>
<span class="nc" id="L1263">			error(EClientErrors.NO_VALID_ID, EClientErrors.UPDATE_TWS.code(),</span>
<span class="nc" id="L1264">					EClientErrors.UPDATE_TWS.msg());</span>
<span class="nc" id="L1265">			return;</span>
		}

<span class="nc" id="L1268">		final int VERSION = 1;</span>

<span class="nc" id="L1270">		send(REQ_FA);</span>
<span class="nc" id="L1271">		send(VERSION);</span>
<span class="nc" id="L1272">		send(faDataType);</span>
<span class="nc" id="L1273">	}</span>

	public synchronized void replaceFA(int faDataType, String xml)
			throws IOException, EException {
		// not connected?
<span class="nc bnc" id="L1278" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L1279">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L1280">			return;</span>
		}

		// This feature is only available for versions of TWS &gt;= 13
<span class="nc bnc" id="L1284" title="All 2 branches missed.">		if (m_serverVersion &lt; 13) {</span>
<span class="nc" id="L1285">			error(EClientErrors.NO_VALID_ID, EClientErrors.UPDATE_TWS.code(),</span>
<span class="nc" id="L1286">					EClientErrors.UPDATE_TWS.msg());</span>
<span class="nc" id="L1287">			return;</span>
		}

<span class="nc" id="L1290">		final int VERSION = 1;</span>

<span class="nc" id="L1292">		send(REPLACE_FA);</span>
<span class="nc" id="L1293">		send(VERSION);</span>
<span class="nc" id="L1294">		send(faDataType);</span>
<span class="nc" id="L1295">		send(xml);</span>
<span class="nc" id="L1296">	}</span>

	public synchronized void reqCurrentTime() throws IOException, EException {
		// not connected?
<span class="nc bnc" id="L1300" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L1301">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L1302">			return;</span>
		}

		// This feature is only available for versions of TWS &gt;= 33
<span class="nc bnc" id="L1306" title="All 2 branches missed.">		if (m_serverVersion &lt; 33) {</span>
<span class="nc" id="L1307">			error(EClientErrors.NO_VALID_ID, EClientErrors.UPDATE_TWS,</span>
					&quot;  It does not support current time requests.&quot;);
<span class="nc" id="L1309">			return;</span>
		}

<span class="nc" id="L1312">		final int VERSION = 1;</span>

<span class="nc" id="L1314">		send(REQ_CURRENT_TIME);</span>
<span class="nc" id="L1315">		send(VERSION);</span>
<span class="nc" id="L1316">	}</span>

	public synchronized void reqFundamentalData(int reqId, Contract contract,
			String reportType) throws IOException, EException {
		// not connected?
<span class="nc bnc" id="L1321" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L1322">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L1323">			return;</span>
		}

<span class="nc bnc" id="L1326" title="All 2 branches missed.">		if (m_serverVersion &lt; MIN_SERVER_VER_FUNDAMENTAL_DATA) {</span>
<span class="nc" id="L1327">			error(reqId, EClientErrors.UPDATE_TWS,</span>
					&quot;  It does not support fundamental data requests.&quot;);
<span class="nc" id="L1329">			return;</span>
		}

<span class="nc" id="L1332">		final int VERSION = 1;</span>

		// send req fund data msg
<span class="nc" id="L1335">		send(REQ_FUNDAMENTAL_DATA);</span>
<span class="nc" id="L1336">		send(VERSION);</span>
<span class="nc" id="L1337">		send(reqId);</span>

		// send contract fields
<span class="nc" id="L1340">		send(contract.m_symbol);</span>
<span class="nc" id="L1341">		send(contract.m_secType);</span>
<span class="nc" id="L1342">		send(contract.m_exchange);</span>
<span class="nc" id="L1343">		send(contract.m_primaryExch);</span>
<span class="nc" id="L1344">		send(contract.m_currency);</span>
<span class="nc" id="L1345">		send(contract.m_localSymbol);</span>

<span class="nc" id="L1347">		send(reportType);</span>
<span class="nc" id="L1348">	}</span>

	public synchronized void cancelFundamentalData(int reqId)
			throws IOException, EException {
		// not connected?
<span class="nc bnc" id="L1353" title="All 2 branches missed.">		if (!isConnected()) {</span>
<span class="nc" id="L1354">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
<span class="nc" id="L1355">			return;</span>
		}

<span class="nc bnc" id="L1358" title="All 2 branches missed.">		if (m_serverVersion &lt; MIN_SERVER_VER_FUNDAMENTAL_DATA) {</span>
<span class="nc" id="L1359">			error(reqId, EClientErrors.UPDATE_TWS,</span>
					&quot;  It does not support fundamental data requests.&quot;);
<span class="nc" id="L1361">			return;</span>
		}

<span class="nc" id="L1364">		final int VERSION = 1;</span>

		// send req mkt data msg
<span class="nc" id="L1367">		send(CANCEL_FUNDAMENTAL_DATA);</span>
<span class="nc" id="L1368">		send(VERSION);</span>
<span class="nc" id="L1369">		send(reqId);</span>
<span class="nc" id="L1370">	}</span>

	protected void error(String err) throws EException {
<span class="nc" id="L1373">		throw new EException(err);</span>
	}

	protected void error(int id, int errorCode, String errorMsg)
			throws EException {
<span class="fc" id="L1378">		throw new EException(id, errorCode, errorMsg);</span>
	}

	protected void close() {
<span class="nc" id="L1382">	}</span>

	private void error(int id, EClientErrors.CodeMsgPair pair, String tail)
			throws EException {
<span class="nc" id="L1386">		error(id, pair.code(), pair.msg() + tail);</span>
<span class="nc" id="L1387">	}</span>

	protected void send(String str) throws IOException {
		// write string to data buffer; writer thread will
		// write it to socket
<span class="pc bpc" id="L1392" title="1 of 2 branches missed.">		if (!IsEmpty(str)) {</span>
<span class="fc" id="L1393">			m_dos.write(str.getBytes());</span>
		}
<span class="fc" id="L1395">		sendEOL();</span>
<span class="fc" id="L1396">	}</span>

	private void sendEOL() throws IOException {
<span class="fc" id="L1399">		m_dos.write(EOL);</span>
<span class="fc" id="L1400">	}</span>

	protected void send(int val) throws IOException {
<span class="fc" id="L1403">		send(String.valueOf(val));</span>
<span class="fc" id="L1404">	}</span>

	protected void send(char val) throws IOException {
<span class="nc" id="L1407">		m_dos.write(val);</span>
<span class="nc" id="L1408">		sendEOL();</span>
<span class="nc" id="L1409">	}</span>

	protected void send(double val) throws IOException {
<span class="nc" id="L1412">		send(String.valueOf(val));</span>
<span class="nc" id="L1413">	}</span>

	protected void send(long val) throws IOException {
<span class="nc" id="L1416">		send(String.valueOf(val));</span>
<span class="nc" id="L1417">	}</span>

	private void sendMax(double val) throws IOException {
<span class="nc bnc" id="L1420" title="All 2 branches missed.">		if (val == Double.MAX_VALUE) {</span>
<span class="nc" id="L1421">			sendEOL();</span>
		} else {
<span class="nc" id="L1423">			send(String.valueOf(val));</span>
		}
<span class="nc" id="L1425">	}</span>

	private void sendMax(int val) throws IOException {
<span class="nc bnc" id="L1428" title="All 2 branches missed.">		if (val == Integer.MAX_VALUE) {</span>
<span class="nc" id="L1429">			sendEOL();</span>
		} else {
<span class="nc" id="L1431">			send(String.valueOf(val));</span>
		}
<span class="nc" id="L1433">	}</span>

	protected void send(boolean val) throws IOException {
<span class="nc bnc" id="L1436" title="All 2 branches missed.">		send(val ? 1 : 0);</span>
<span class="nc" id="L1437">	}</span>

	private static boolean IsEmpty(String str) {
<span class="fc" id="L1440">		return Util.StringIsEmpty(str);</span>
	}

	public DataInputStream dataInputStream() throws EException {
		// not connected?
<span class="fc bfc" id="L1445" title="All 2 branches covered.">		if (!isConnected()) {</span>
<span class="nc" id="L1446">			error(EClientErrors.NO_VALID_ID, EClientErrors.NOT_CONNECTED, &quot;&quot;);</span>
		}

<span class="fc" id="L1449">		return m_dis;</span>
	}

	DataInputStream createDataInputStream(Socket socket) throws IOException {
<span class="nc" id="L1453">		return new DataInputStream(socket.getInputStream());</span>
	}

	DataOutputStream createDataOutputStream(Socket socket) throws IOException {
<span class="nc" id="L1457">		return new DataOutputStream(socket.getOutputStream());</span>
	}

	Socket createSocket(String host, int port) throws IOException {
<span class="nc" id="L1461">		return new Socket(host, port);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>